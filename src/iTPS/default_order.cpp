/* TeNeS - Massively parallel tensor network solver /
/ Copyright (C) 2019- The University of Tokyo */

/* This program is free software: you can redistribute it and/or modify /
/ it under the terms of the GNU General Public License as published by /
/ the Free Software Foundation, either version 3 of the License, or /
/ (at your option) any later version. */

/* This program is distributed in the hope that it will be useful, /
/ but WITHOUT ANY WARRANTY; without even the implied warranty of /
/ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the /
/ GNU General Public License for more details. */

/* You should have received a copy of the GNU General Public License /
/ along with this program. If not, see http://www.gnu.org/licenses/. */

#include "contraction_order.hpp"

namespace tenes {
namespace itps {

std::vector<std::vector<std::vector<int>>> make_default_order_itpo_ctm() {
  std::vector<std::vector<std::vector<int>>> order_table(
      4, std::vector<std::vector<int>>(4));

  // nrow = 1
  order_table[0][0] = {};
  order_table[0][1] = {
      10, 4, 0, 9, -1, -1, 3,  7,  -1, 5,  8,  11,
      -1, 1, 2, 6, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[0][2] = {
      12, 4, 0, 11, -1, -1, 3,  8,  -1, 5,  13, 9,  6,  10, 14,
      -1, 1, 2, 7,  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[0][3] = {
      14, 4, 0,  13, -1, -1, 3,  9,  -1, 5,  15, 10, 6,  16, 11, 7,  12, 1,
      2,  8, 17, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };

  // nrow = 2
  order_table[1][0] = {
      10, 4, 1, 5, -1, -1, 0,  8,  -1, 6,  9,  11,
      -1, 2, 3, 7, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[1][1] = {
      12, 4,  0,  10, -1, -1, 1,  5, -1, 6,  13, -1, -1, 3,  8,  -1,
      11, 14, -1, -1, 2,  7,  -1, 9, 15, -1, -1, -1, -1, -1, -1,
  };
  order_table[1][2] = {
      14, 4,  0,  12, -1, -1, 3,  9,  -1, 13, 17, -1, -1,
      5,  15, 18, 10, 1,  6,  -1, 7,  16, -1, -1, 2,  8,
      -1, 11, 19, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[1][3] = {
      16, 4,  0,  14, -1, -1, 3,  10, -1, 15, 20, -1, -1, 5,  17, 21,
      11, 6,  18, 22, 12, 1,  7,  -1, 8,  19, -1, -1, 2,  9,  -1, 13,
      23, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };

  // nrow = 3
  order_table[2][0] = {
      12, 4, 1, 5, -1, -1, 0,  9,  -1, 6,  13, 10, 7,  11, 14,
      -1, 2, 3, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[2][1] = {
      14, 4,  0,  11, -1, -1, 1,  5,  -1, 6,  15, -1, -1,
      7,  17, 16, 12, 3,  9,  -1, 13, 18, -1, -1, 2,  8,
      -1, 10, 19, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[2][2] = {
      16, 4,  0,  13, -1, -1, 5,  17, 6,  18, 1,  7,  -1, 8,  21, 20, 19,
      14, 2,  9,  -1, 3,  10, 15, 22, -1, -1, -1, 11, 23, -1, 12, 24, -1,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[2][3] = {
      18, 4,  0,  15, -1, -1, 16, 22, 17, 26, 3,  11, -1, 5,  19,
      23, 27, 12, 6,  20, 24, 28, 13, 1,  7,  -1, 8,  21, -1, 9,
      25, -1, -1, 2,  10, 14, 29, -1, -1, -1, -1, -1, -1, -1, -1,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };

  // nrow = 4
  order_table[3][0] = {
      14, 4, 1,  5,  -1, -1, 0,  10, -1, 6,  15, 11, 7,  16, 12, 8,  13, 2,
      3,  9, 17, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[3][1] = {
      16, 4,  0,  12, -1, -1, 1,  5,  -1, 6,  17, -1, -1, 7,  19, 18,
      13, 8,  21, 20, 14, 3,  10, -1, 15, 22, -1, -1, 2,  9,  -1, 11,
      23, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[3][2] = {
      18, 4,  0,  14, -1, -1, 5,  19, 6,  20, 1,  7,  -1, 8,  23,
      22, 21, 15, 9,  26, 25, 24, 16, 2,  10, -1, 3,  11, 17, 27,
      -1, -1, -1, 12, 28, -1, 13, 29, -1, -1, -1, -1, -1, -1, -1,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[3][3] = {
      20, 4,  0,  16, -1, -1, 5,  21, 6,  22, 1,  7,  8,  23, -1, -1, -1, 9,
      27, 26, 25, 24, 17, 10, 31, 30, 29, 28, 18, 11, 35, 32, 33, 34, -1, -1,
      14, 2,  15, -1, -1, 13, 12, 3,  19, -1, -1, -1, -1, -1, -1, -1, -1, -1,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };

  return order_table;
}

std::vector<std::vector<std::vector<int>>> make_default_order_itps_ctm() {
  std::vector<std::vector<std::vector<int>>> order_table(
      4, std::vector<std::vector<int>>(4));

  // nrow = 1
  order_table[0][0] = {};
  order_table[0][1] = {
      0, 4,  9,  10, 12, 3,  7,  -1, 5,  11, 1,  6,  -1, 2,
      8, 13, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[0][2] = {
      0,  4,  11, 12, 15, 3,  8,  -1, 5,  13, 16, 9,  14, 6,  1,  7,  -1, 2,
      10, 17, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[0][3] = {
      0,  4,  13, 14, 18, 3,  9,  -1, 5,  15, 19, 10, 6,  16, 20,
      11, 17, 7,  1,  8,  -1, 2,  12, 21, -1, -1, -1, -1, -1, -1,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };

  // nrow = 2
  order_table[1][0] = {
      0,  4,  1,  5,  10, 12, 8,  6,  11, 2,  7,  -1, 3,  9,
      13, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[1][1] = {
      0,  4,  10, 12, 16, 5,  13, 17, 1,  6,  -1, 3,  8,
      -1, 11, 14, 18, -1, -1, -1, 2,  7,  -1, 9,  15, 19,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[1][2] = {
      0,  4,  12, 14, 20, 13, 17, 23, 3,  9,  -1, 5,  15, 21, 18, 24, 10,
      1,  6,  -1, 7,  16, 22, -1, -1, -1, 2,  8,  -1, 11, 19, 25, -1, -1,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[1][3] = {
      5,  17, 25, 21, 29, 11, 0,  4,  -1, 14, 16, 24, -1, -1, -1, 3,
      10, -1, 15, 20, 28, -1, -1, -1, -1, -1, -1, -1, -1, -1, 6,  18,
      26, 22, 30, 12, 1,  7,  -1, 8,  19, 27, -1, -1, -1, 2,  9,  -1,
      13, 23, 31, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };

  // nrow = 3
  order_table[2][0] = {
      0,  4,  1,  5,  12, 15, 9,  6,  13, 16, 10, 14, 7,  2,  8,  -1, 3,  11,
      17, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[2][1] = {
      0,  4,  11, 14, 20, 5,  15, 21, 1,  6,  -1, 7,  17, 23, 16, 22, 12,
      3,  9,  -1, 13, 18, 24, -1, -1, -1, 2,  8,  -1, 10, 19, 25, -1, -1,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[2][2] = {
      0,  4,  13, 16, 25, 5,  17, 26, 1,  6,  18, -1, 7,  27, -1, -1, -1,
      8,  21, 30, 20, 29, 19, 28, 14, 3,  10, 22, -1, 15, 31, -1, -1, -1,
      23, 32, 2,  11, 9,  24, -1, 12, 33, -1, -1, -1, -1, -1, -1, -1, -1,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[2][3] = {
      0,  4,  15, 18, 30, 16, 22, 34, 3,  11, 26, -1, 17, 38, -1, -1, -1,
      5,  19, 31, 23, 35, 27, 39, 12, 6,  20, 32, 24, 36, 28, 40, 13, 1,
      7,  21, -1, 8,  33, -1, -1, -1, 25, 37, 29, 2,  9,  10, 14, 41, -1,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };

  // nrow = 4
  order_table[3][0] = {
      0,  4,  1,  5,  14, 18, 10, 6,  15, 19, 11, 7,  16, 20, 12,
      17, 8,  2,  9,  -1, 3,  13, 21, -1, -1, -1, -1, -1, -1, -1,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[3][1] = {
      7,  19, 27, 18, 26, 13, 0,  4,  -1, 12, 16, 24, -1, -1, -1, 1,
      5,  -1, 6,  17, 25, -1, -1, -1, -1, -1, -1, -1, -1, -1, 8,  21,
      29, 20, 28, 14, 3,  10, -1, 15, 22, 30, -1, -1, -1, 2,  9,  -1,
      11, 23, 31, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[3][2] = {
      0,  4,  14, 18, 30, 5,  19, 31, 1,  6,  20, -1, 7,  32, -1, -1, -1,
      8,  23, 35, 22, 34, 21, 33, 15, 9,  26, 38, 25, 37, 24, 36, 16, 3,
      11, 27, -1, 17, 39, -1, -1, -1, 28, 40, 29, 2,  12, 10, 13, 41, -1,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[3][3] = {
      0,  4,  16, 20, 36, 5,  21, 37, 6,  22, 38, 1,  7,  23, -1, 8,  39, -1,
      -1, -1, 9,  27, 43, 26, 42, 25, 41, 24, 40, 17, 10, 31, 47, 30, 46, 29,
      45, 28, 44, 18, 3,  12, 32, -1, 19, 48, -1, -1, -1, 33, 49, 35, 51, -1,
      11, 2,  15, -1, -1, 13, 14, -1, 34, 50, -1, -1, -1, -1, -1, -1, -1, -1,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };

  return order_table;
}

std::vector<std::vector<std::vector<int>>> make_default_order_itps_mf() {
  std::vector<std::vector<std::vector<int>>> order_table(
      5, std::vector<std::vector<int>>(5));

  // nrow = 1
  order_table[0][0] = {};
  order_table[0][1] = {
      0, 2, -1, 1, 3, -1, -1,
  };
  order_table[0][2] = {
      0, 3, -1, 1, 4, 2, 5, -1, -1, -1, -1,
  };
  order_table[0][3] = {
      0, 4, -1, 1, 5, -1, 3, 2, 6, 7, -1, -1, -1, -1, -1,
  };
  order_table[0][4] = {
      0, 5, -1, 4, 9, -1, 1, 6, -1, 2, 3, 7, 8, -1, -1, -1, -1, -1, -1,
  };

  // nrow = 2
  order_table[1][0] = {
      0, 2, -1, 1, 3, -1, -1,
  };
  order_table[1][1] = {
      0, 4, -1, 1, 5, -1, 2, 6, -1, 3, 7, -1, -1, -1, -1,
  };
  order_table[1][2] = {
      0, 6,  -1, 3,  9,  -1, 1,  7,  -1, 2,  8,  -1,
      4, 10, 5,  11, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[1][3] = {
      0,  8,  -1, 4, 12, -1, 1,  9,  -1, 5,  13, -1, 2,  10, -1, 6,
      14, -1, 3,  7, 11, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[1][4] = {
      0,  10, -1, 5,  15, -1, 1,  11, -1, 6,  16, -1, 2,
      12, -1, 7,  17, -1, 3,  8,  13, 18, -1, 4,  9,  14,
      19, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };

  // nrow = 3
  order_table[2][0] = {
      0, 3, -1, 1, 4, 2, 5, -1, -1, -1, -1,
  };
  order_table[2][1] = {
      0, 6, -1, 1,  7,  -1, 2,  8,  -1, 4,  10, -1,
      3, 9, 5,  11, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[2][2] = {
      0,  9,  -1, 1, 10, -1, 2,  11, -1, 3,  12, -1, 6,  15, -1, 4,  5,  13,
      14, -1, -1, 8, 7,  16, 17, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[2][3] = {
      0,  12, -1, 4,  16, -1, 8,  20, -1, 1,  13, -1, 5,  17, 9,  21,
      -1, 2,  14, -1, 6,  10, 18, 22, -1, 3,  7,  -1, 11, 15, 19, 23,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[2][4] = {
      0,  15, -1, 5,  20, -1, 10, 25, -1, 1,  16, -1, 6,  21, 11,
      26, -1, 2,  17, -1, 7,  22, 12, 27, -1, 3,  18, -1, 8,  13,
      28, 23, 24, -1, 19, 29, 4,  9,  14, -1, -1, -1, -1, -1, -1,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };

  // nrow = 4
  order_table[3][0] = {
      0, 4, -1, 1, 5, -1, 3, 2, 6, 7, -1, -1, -1, -1, -1,
  };
  order_table[3][1] = {
      0,  8,  -1, 1, 9,  -1, 2,  10, -1, 3,  11, -1, 4,  12, -1, 5,
      13, -1, 6,  7, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[3][2] = {
      0,  12, -1, 1,  13, -1, 2,  14, -1, 3,  15, -1, 4,  16, 5,  17,
      -1, 6,  18, -1, 7,  8,  19, 20, -1, 9,  10, -1, 11, 21, 22, 23,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[3][3] = {
      0,  16, -1, 1,  17, -1, 4,  20, -1, 5,  21, 2,  18, -1, 6,  22,
      3,  7,  19, 23, -1, -1, -1, 8,  24, -1, 9,  25, 12, 13, 28, 29,
      -1, -1, -1, 10, 11, 27, 31, -1, -1, 14, 15, -1, 26, 30, -1, -1,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[3][4] = {
      0,  20, -1, 1,  21, -1, 5,  25, -1, 6,  26, 10, 30, -1, 11, 31,
      15, 16, 35, 36, -1, -1, -1, 2,  22, -1, 7,  27, 12, 32, 17, 37,
      -1, 3,  23, -1, 8,  28, 13, 18, 24, 29, -1, 4,  9,  14, -1, -1,
      -1, 19, 33, 34, 38, 39, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };

  // nrow = 5
  order_table[4][0] = {
      0, 5, -1, 4, 9, -1, 1, 6, -1, 2, 3, 7, 8, -1, -1, -1, -1, -1, -1,
  };
  order_table[4][1] = {
      0,  10, -1, 1,  11, -1, 2,  12, -1, 3,  13, -1, 4,
      14, -1, 5,  15, -1, 6,  7,  16, 17, -1, 8,  9,  18,
      19, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[4][2] = {
      0,  15, -1, 1,  16, -1, 2,  17, -1, 3,  18, -1, 4,  19, 5,
      20, -1, 6,  21, -1, 7,  22, 8,  23, -1, 9,  24, -1, 10, 11,
      26, 25, 28, -1, 27, 29, 12, 13, 14, -1, -1, -1, -1, -1, -1,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[4][3] = {
      0,  20, -1, 1,  21, -1, 4,  24, -1, 5,  25, 2,  22, -1, 6,  26,
      3,  7,  23, 27, -1, -1, -1, 8,  28, -1, 9,  29, 10, 30, 11, 31,
      -1, 12, 32, -1, 13, 33, 14, 15, 36, 37, -1, 16, 17, 18, -1, -1,
      -1, 19, 34, 35, 38, 39, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };
  order_table[4][4] = {
      0,  25, -1, 1,  26, -1, 5,  30, -1, 6,  31, 2,  27, -1, 7,  32, 3,
      28, -1, 8,  33, 4,  9,  29, 34, -1, -1, -1, 10, 35, -1, 11, 36, 12,
      37, 13, 38, 14, 39, -1, 15, 40, -1, 16, 41, 20, 21, 45, 46, -1, -1,
      -1, 17, 22, 44, 18, 19, -1, -1, 24, 43, 42, 47, -1, -1, 23, 48, 49,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
  };

  return order_table;
}

std::vector<int> default_order(int nrows, int ncols, bool is_tpo, bool is_mf) {
  static std::vector<std::vector<std::vector<int>>> order_table_itpo_ctm =
      make_default_order_itpo_ctm();
  static std::vector<std::vector<std::vector<int>>> order_table_itps_ctm =
      make_default_order_itps_ctm();
  static std::vector<std::vector<std::vector<int>>> order_table_itps_mf =
      make_default_order_itps_mf();
  if (is_tpo) {
    if (is_mf) {
      throw std::runtime_error("not implemented");
    } else {
      if (nrows > 4 || ncols > 4) {
        return {};
      }
      return order_table_itpo_ctm[nrows - 1][ncols - 1];
    }
  } else {
    if (is_mf) {
      if (nrows > 5 || ncols > 5) {
        return {};
      }
      return order_table_itps_mf[nrows - 1][ncols - 1];
    } else {
      if (nrows > 4 || ncols > 4) {
        return {};
      }
      return order_table_itps_ctm[nrows - 1][ncols - 1];
    }
  }
}

}  // namespace itps
}  // namespace tenes
